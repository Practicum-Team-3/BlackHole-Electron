<!doctype html>
<!-- Bridge 1.0.0 -->
<html>
    <head>
        <title>Bridge</title>
    
        <script src="../widow.js"></script>
        
        <script>
            function axiosBridge(config, ...promiseCallbacks){
                console.log("<> called into axiosBridge")
                electron.remote.getCurrentWebContents().session.clearStorageData(["cookies"])
                // Create instance
                var axios = require('axios')(config)
                
                promiseCallbacks.forEach(function(callback, index, callbacks){
                    // If only one callback passed, or the current one is not the last, use it for the then
                    if (callbacks.length==1 || index<callbacks.length-1){
                        
                        axios = axios.then(callback)
                        
                    }else{//Otherwise, use on the catch
                        
                        //Since the original error parameter passed to catch can't be passed to main, some transformation is needed
                        axios.catch(function(callback, error){
                            
                            var traErr = JSON.parse(JSON.stringify(error))
                            traErr.response = JSON.parse(JSON.stringify(error.response))
                            
                            callback(traErr)
                        }.bind(null, callback))
                    }
                })
            }
            
            widow.setAxiosBridge(axiosBridge)
            
            
            function uploadExp(){
                electron.remote.getCurrentWebContents().session.clearStorageData(["cookies"])
                const axios = require('axios')
                
                var fileList = document.getElementById("fileSelect").files
                var file = fileList[0]
                
                const fs = require('fs')
                stream = fs.createReadStream(file.path);
                stream.pause()
                
                stream.on('data', (chunk) => {
                    console.log(`Received ${chunk.length} bytes of data.`);
                    stream.pause();
                });
                
                var plok = function(){
                    console.log("conconconconc")
                }
//                file.stream = plok
//                file.arrayBuffer = plok
//                file.slice = plok
//                file.text = plok
//                
//                
//                var blob = new Blob(["ahdadadwd22"])
//                
//                blob.stream = plok
//                blob.arrayBuffer = plok
//                blob.slice = plok
//                blob.text = plok
                
                // /Users/LaunchZone/Downloads/registry.txt
                /*
                var stream = file.stream()
                var reader = stream.getReader()

                reader.read().then(function processText({done, value}){
                    if (!done){
                        hash.update(value)
                        return reader.read().then(processText);

                    }else{
                        hash = hash.digest("hex")
                        onHashCalculated()
                    }
                })
                */
                
                
                axios({
                    method: "put",
                    url: "http://nextcloud.localhost:9933/remote.php/dav/files/admin/programs/bin/loco.txt",
                    auth: {
                        username: "admin",
                        password: "password"
                    },
                    data: file.stream(),
                    onUploadProgress: function (progressEvent) {
                        console.log("Pr: "+progressEvent.loaded+"/"+progressEvent.total)
                    }
                }).then(function (response) {

                    console.log(response)

                }.bind(this)).catch(function (error) {

                    console.log(error)

                }.bind(this))
                
                
            }
        </script>
    </head>
    <body>
        <input type="file" class="form-control" id="fileSelect" required>
    </body>
</html>